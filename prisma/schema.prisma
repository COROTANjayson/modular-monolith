generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

model User {
    id                       String    @id @default(uuid())
    firstName                String?
    lastName                 String?
    email                    String    @unique
    password                 String?
    googleId                 String?   @unique
    avatar                   String?
    age                      Int?
    gender                   String?
    createdAt                DateTime  @default(now())
    updatedAt                DateTime  @updatedAt
    // For refresh token rotation using JTI approach:
    currentTokenId           String?
    isVerified               Boolean   @default(false)
    verificationToken        String?   @unique
    verificationTokenExpires DateTime?

    organizationMembers OrganizationMember[]
    notifications       Notification[]
    teamMembers         TeamMember[]
    teamsLed            Team[] @relation("TeamLeader")
}

model Organization {
    id      String @id @default(cuid())
    name    String
    slug    String @unique
    ownerId String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    members     OrganizationMember[]
    invitations OrganizationInvitation[]
    teams       Team[]
}

model OrganizationMember {
    id             String                   @id @default(cuid())
    organizationId String
    userId         String
    role           OrganizationRole
    status         OrganizationMemberStatus

    invitedAt DateTime  @default(now())
    joinedAt  DateTime?

    organization Organization @relation(fields: [organizationId], references: [id])
    user         User         @relation(fields: [userId], references: [id])

    @@unique([organizationId, userId])
}

model OrganizationInvitation {
    id             String           @id @default(cuid())
    organizationId String
    inviterId      String
    email          String
    role           OrganizationRole
    token          String           @unique

    expiresAt  DateTime
    acceptedAt DateTime?

    createdAt DateTime @default(now())

    organization Organization @relation(fields: [organizationId], references: [id])
}

model Team {
    id             String   @id @default(cuid())
    organizationId String
    name           String
    description    String?
    leaderId       String
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    organization Organization @relation(fields: [organizationId], references: [id])
    leader       User         @relation("TeamLeader", fields: [leaderId], references: [id]) // Virtual relation for leader
    members      TeamMember[]

    @@unique([organizationId, name])
}

model TeamMember {
    id        String   @id @default(cuid())
    teamId    String
    userId    String
    joinedAt  DateTime @default(now())

    team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([teamId, userId])
}

enum OrganizationRole {
    owner
    admin
    team_lead
    member
}

enum OrganizationMemberStatus {
    invited
    active
    suspended
    left
}

model Notification {
    id        String    @id @default(cuid())
    userId    String
    type      String
    title     String
    message   String
    metadata    Json?
    redirectUrl String?
    isRead    Boolean   @default(false)
    readAt    DateTime?
    createdAt DateTime  @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId, isRead, createdAt])
}
